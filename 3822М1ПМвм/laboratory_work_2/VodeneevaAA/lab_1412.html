<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>06a38ca1abc344df9ec8d80b6acd0a90</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div class="cell code" data-execution_count="1"
data-_cell_guid="b1076dfc-b9ad-4769-8c92-a6c4dae69d19"
data-_uuid="8f2839f25d086af736a60e9eeb907d3b93b6e0e5"
data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-26T17:59:45.734337Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-26T17:59:45.733999Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-26T18:00:10.084698Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-26T18:00:10.083684Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-26T17:59:45.734308Z&quot;}"
data-papermill="{&quot;duration&quot;:12.6145,&quot;end_time&quot;:&quot;2023-05-13T14:02:46.407433&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-05-13T14:02:33.792933&quot;,&quot;status&quot;:&quot;completed&quot;}"
data-tags="[]" data-trusted="true">
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset, DataLoader</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> transforms</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> datasets, models, transforms</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> PIL</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelEncoder</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.patches <span class="im">as</span> patches</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.font_manager <span class="im">import</span> FontProperties</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">&quot;ignore&quot;</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>train_on_gpu <span class="op">=</span> torch.cuda.is_available()</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>dict_characters <span class="op">=</span> {<span class="dv">0</span>: <span class="st">&#39;abraham_grampa_simpson&#39;</span>, <span class="dv">1</span>: <span class="st">&#39;apu_nahasapeemapetilon&#39;</span>, <span class="dv">2</span>: <span class="st">&#39;bart_simpson&#39;</span>, <span class="dv">3</span>: <span class="st">&#39;charles_montgomery_burns&#39;</span>, <span class="dv">4</span>: <span class="st">&#39;chief_wiggum&#39;</span>, <span class="dv">5</span>: <span class="st">&#39;comic_book_guy&#39;</span>, <span class="dv">6</span>: <span class="st">&#39;edna_krabappel&#39;</span>, <span class="dv">7</span>: <span class="st">&#39;homer_simpson&#39;</span>, <span class="dv">8</span>: <span class="st">&#39;kent_brockman&#39;</span>, <span class="dv">9</span>: <span class="st">&#39;krusty_the_clown&#39;</span>, <span class="dv">10</span>: <span class="st">&#39;lenny_leonard&#39;</span>, <span class="dv">11</span>:<span class="st">&#39;lisa_simpson&#39;</span>, <span class="dv">12</span>: <span class="st">&#39;marge_simpson&#39;</span>, <span class="dv">13</span>: <span class="st">&#39;mayor_quimby&#39;</span>,<span class="dv">14</span>:<span class="st">&#39;milhouse_van_houten&#39;</span>, <span class="dv">15</span>: <span class="st">&#39;moe_szyslak&#39;</span>, <span class="dv">16</span>: <span class="st">&#39;ned_flanders&#39;</span>, <span class="dv">17</span>: <span class="st">&#39;nelson_muntz&#39;</span>, <span class="dv">18</span>: <span class="st">&#39;principal_skinner&#39;</span>, <span class="dv">19</span>: <span class="st">&#39;sideshow_bob&#39;</span>}</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>train_dir <span class="op">=</span> Path(<span class="st">&#39;/kaggle/input/the-simpsons-characters-dataset/simpsons_dataset/&#39;</span>)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>test_dir <span class="op">=</span> Path(<span class="st">&#39;/kaggle/input/the-simpsons-characters-dataset/kaggle_simpson_testset/&#39;</span>)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>train_val_files_path <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">list</span>(train_dir.rglob(<span class="st">&#39;*.jpg&#39;</span>)))</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>test_path <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">list</span>(test_dir.rglob(<span class="st">&#39;*.jpg&#39;</span>)))</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>train_val_labels <span class="op">=</span> [path.parent.name <span class="cf">for</span> path <span class="kw">in</span> train_val_files_path]</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>train_files_path, val_files_path <span class="op">=</span> train_test_split(train_val_files_path, test_size <span class="op">=</span> <span class="fl">0.3</span>, stratify<span class="op">=</span>train_val_labels)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>num_classes <span class="op">=</span> <span class="bu">len</span>(np.unique(train_val_labels))</span></code></pre></div>
<div class="output stream stderr">
<pre><code>/opt/conda/lib/python3.10/site-packages/scipy/__init__.py:146: UserWarning: A NumPy version &gt;=1.16.5 and &lt;1.23.0 is required for this version of SciPy (detected version 1.24.3
  warnings.warn(f&quot;A NumPy version &gt;={np_minversion} and &lt;{np_maxversion}&quot;
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="2"
data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-26T18:00:10.087149Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-26T18:00:10.086726Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-26T18:00:10.100355Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-26T18:00:10.099306Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-26T18:00:10.087121Z&quot;}"
data-papermill="{&quot;duration&quot;:2.5121e-2,&quot;end_time&quot;:&quot;2023-05-13T14:02:46.454350&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-05-13T14:02:46.429229&quot;,&quot;status&quot;:&quot;completed&quot;}"
data-tags="[]" data-trusted="true">
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ConvolutionNetwork(nn.Module):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, img_size: Tuple[<span class="bu">int</span>, <span class="bu">int</span>] <span class="op">=</span> (<span class="dv">3</span>, <span class="dv">224</span>, <span class="dv">224</span>), num_classes: <span class="bu">int</span> <span class="op">=</span> num_classes):</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        in_channels <span class="op">=</span> img_size[<span class="dv">0</span>]</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        height <span class="op">=</span> img_size[<span class="dv">1</span>]</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        width <span class="op">=</span> img_size[<span class="dv">2</span>]</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv1 <span class="op">=</span> nn.Conv2d(<span class="dv">3</span>, <span class="dv">32</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, stride<span class="op">=</span><span class="dv">1</span>, padding<span class="op">=</span><span class="st">&#39;same&#39;</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.btch <span class="op">=</span> nn.BatchNorm2d(<span class="dv">32</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.relu1 <span class="op">=</span> nn.ReLU()</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pool1 <span class="op">=</span> nn.MaxPool2d(kernel_size<span class="op">=</span><span class="dv">2</span>, stride<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv2 <span class="op">=</span> nn.Conv2d(<span class="dv">32</span>, <span class="dv">64</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, stride<span class="op">=</span><span class="dv">1</span>, padding<span class="op">=</span><span class="st">&#39;same&#39;</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.btch <span class="op">=</span> nn.BatchNorm2d(<span class="dv">64</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.relu2 <span class="op">=</span> nn.ReLU()</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pool2 <span class="op">=</span> nn.MaxPool2d(kernel_size<span class="op">=</span><span class="dv">2</span>, stride<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv3 <span class="op">=</span> nn.Conv2d(<span class="dv">64</span>, <span class="dv">128</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, stride<span class="op">=</span><span class="dv">1</span>, padding<span class="op">=</span><span class="st">&#39;same&#39;</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.btch <span class="op">=</span> nn.BatchNorm2d(<span class="dv">128</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.relu3 <span class="op">=</span> nn.ReLU()</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pool3 <span class="op">=</span> nn.MaxPool2d(kernel_size<span class="op">=</span><span class="dv">2</span>, stride<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc1 <span class="op">=</span> nn.Linear(<span class="dv">128</span> <span class="op">*</span> <span class="dv">28</span> <span class="op">*</span> <span class="dv">28</span>, <span class="dv">64</span>)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.relu4 <span class="op">=</span> nn.ReLU()</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc2 <span class="op">=</span> nn.Linear(<span class="dv">64</span>, num_classes)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> nn.Dropout(<span class="fl">0.25</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.conv1(x)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.relu1(x)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.pool1(x)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.conv2(x)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.relu2(x)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.pool2(x)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.conv3(x)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.relu3(x)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.pool3(x)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x.view(x.size(<span class="dv">0</span>), <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.fc1(x)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.relu4(x)</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.dropout(x)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.fc2(x)</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="3"
data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-26T18:00:10.102009Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-26T18:00:10.101643Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-26T18:00:10.124806Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-26T18:00:10.123926Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-26T18:00:10.101968Z&quot;}"
data-papermill="{&quot;duration&quot;:1.8944e-2,&quot;end_time&quot;:&quot;2023-05-13T14:02:46.480527&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-05-13T14:02:46.461583&quot;,&quot;status&quot;:&quot;completed&quot;}"
data-tags="[]" data-trusted="true">
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SimpsonsDataset(Dataset):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, files_path, data_transforms):</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.files_path <span class="op">=</span> files_path</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.transform <span class="op">=</span> data_transforms</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">&#39;test&#39;</span> <span class="kw">not</span> <span class="kw">in</span> <span class="bu">str</span>(<span class="va">self</span>.files_path[<span class="dv">0</span>]):</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.labels <span class="op">=</span> [path.parent.name <span class="cf">for</span> path <span class="kw">in</span> <span class="va">self</span>.files_path]</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.label_encoder <span class="op">=</span> LabelEncoder()</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.label_encoder.fit(<span class="va">self</span>.labels)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;label_encoder.pkl&#39;</span>, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> le_dump_file:</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                pickle.dump(<span class="va">self</span>.label_encoder, le_dump_file)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.files_path)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        img_path <span class="op">=</span> <span class="bu">str</span>(<span class="va">self</span>.files_path[idx])</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> Image.<span class="bu">open</span>(img_path).convert(<span class="st">&#39;RGB&#39;</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> <span class="va">self</span>.transform(image)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">&#39;test&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(<span class="va">self</span>.files_path[<span class="dv">0</span>]):</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> image</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>            label_str <span class="op">=</span> <span class="bu">str</span>(<span class="va">self</span>.files_path[idx].parent.name)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>            label <span class="op">=</span> <span class="va">self</span>.label_encoder.transform([label_str]).item()</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> image, label</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="4"
data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-26T18:00:10.126181Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-26T18:00:10.125893Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-26T18:00:13.152866Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-26T18:00:13.151880Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-26T18:00:10.126157Z&quot;}"
data-papermill="{&quot;duration&quot;:2.884919,&quot;end_time&quot;:&quot;2023-05-13T14:02:49.386869&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-05-13T14:02:46.501950&quot;,&quot;status&quot;:&quot;completed&quot;}"
data-tags="[]" data-trusted="true">
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">&quot;cuda&quot;</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">&quot;cpu&quot;</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> ConvolutionNetwork()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model.to(device)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>input_size <span class="op">=</span> <span class="dv">224</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> nn.CrossEntropyLoss() </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.SGD(params<span class="op">=</span>model.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>, momentum<span class="op">=</span><span class="fl">0.9</span>)</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="5"
data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-26T18:00:13.155741Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-26T18:00:13.155423Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-26T18:00:13.285670Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-26T18:00:13.284939Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-26T18:00:13.155714Z&quot;}"
data-papermill="{&quot;duration&quot;:0.168201,&quot;end_time&quot;:&quot;2023-05-13T14:02:49.562619&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-05-13T14:02:49.394418&quot;,&quot;status&quot;:&quot;completed&quot;}"
data-tags="[]" data-trusted="true">
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>train_dataset <span class="op">=</span> SimpsonsDataset(train_files_path, transforms.Compose([transforms.Resize((input_size,input_size)), transforms.ToTensor()]))</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>val_dataset <span class="op">=</span> SimpsonsDataset(val_files_path, transforms.Compose([transforms.Resize((input_size,input_size)), transforms.ToTensor()]))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>test_dataset <span class="op">=</span> SimpsonsDataset(test_path, transforms.Compose([transforms.Resize((input_size,input_size)), transforms.ToTensor()]))</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>sample <span class="op">=</span> test_dataset[<span class="dv">0</span>]</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="14"
data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-26T19:34:41.935908Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-26T19:34:41.935312Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-26T19:34:41.942805Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-26T19:34:41.941599Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-26T19:34:41.935871Z&quot;}"
data-papermill="{&quot;duration&quot;:1.5915e-2,&quot;end_time&quot;:&quot;2023-05-13T14:02:49.600565&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-05-13T14:02:49.584650&quot;,&quot;status&quot;:&quot;completed&quot;}"
data-tags="[]" data-trusted="true">
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>dataloader_train_dataset <span class="op">=</span> DataLoader(train_dataset, batch_size<span class="op">=</span><span class="dv">256</span>, shuffle<span class="op">=</span><span class="va">True</span>, num_workers<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>dataloader_val_dataset <span class="op">=</span> DataLoader(val_dataset, batch_size<span class="op">=</span><span class="dv">256</span>, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>dataloader_test_dataset <span class="op">=</span> DataLoader(test_dataset, batch_size<span class="op">=</span><span class="dv">256</span>, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">4</span>)</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="7"
data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-26T18:00:13.293205Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-26T18:00:13.292869Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-26T18:00:13.306001Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-26T18:00:13.304996Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-26T18:00:13.293180Z&quot;}"
data-papermill="{&quot;duration&quot;:1.9752e-2,&quot;end_time&quot;:&quot;2023-05-13T14:02:49.641854&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-05-13T14:02:49.622102&quot;,&quot;status&quot;:&quot;completed&quot;}"
data-tags="[]" data-trusted="true">
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_accuracy(model, data_loader, device):</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> images, labels <span class="kw">in</span> data_loader:</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>            labels <span class="op">=</span> labels.to(device)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>            images <span class="op">=</span> images.to(device)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> model(images)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>            _, predicted <span class="op">=</span> torch.<span class="bu">max</span>(outputs.data, <span class="dv">1</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sklearn.metrics.f1_score(predicted, labels)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_f1_score(model, data_loader, device):</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    predicted_labels <span class="op">=</span> []</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    true_labels <span class="op">=</span> []</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> images, labels <span class="kw">in</span> data_loader:</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>            labels <span class="op">=</span> labels.to(device)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>            images <span class="op">=</span> images.to(device)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> model(images)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>            _, predicted <span class="op">=</span> torch.<span class="bu">max</span>(outputs.data, <span class="dv">1</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>            predicted_labels.extend(predicted.cpu().numpy())</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>            true_labels.extend(labels.cpu().numpy())</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sklearn.metrics.f1_score(true_labels, predicted_labels, average<span class="op">=</span><span class="st">&#39;weighted&#39;</span>)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> accuracy(outputs, labels):</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    _, predicted <span class="op">=</span> torch.<span class="bu">max</span>(outputs.data, <span class="dv">1</span>)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.tensor(torch.<span class="bu">sum</span>(predicted <span class="op">==</span> labels).item() <span class="op">/</span> <span class="bu">len</span>(predicted))</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train(cnn_model, data_loader, epochs, loss_function, optimizer, device):</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> time.time()</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        startep <span class="op">=</span> time.time()</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>        accs <span class="op">=</span> []</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, (images, labels) <span class="kw">in</span> <span class="bu">enumerate</span>(data_loader):</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>            labels <span class="op">=</span> labels.to(device)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>            images <span class="op">=</span> images.to(device)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> cnn_model(images)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> loss_function(outputs, labels)</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>            acc <span class="op">=</span> accuracy(outputs, labels)</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>            accs.append(acc)</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>            endep <span class="op">=</span> time.time()</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&#39;Epoch </span><span class="sc">{}</span><span class="st">: acc = </span><span class="sc">{}</span><span class="st">, time = </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(epoch <span class="op">+</span> <span class="dv">1</span>, torch.stack(accs).mean(), endep <span class="op">-</span> startep))</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> time.time()</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;Total time </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(end <span class="op">-</span> start))</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="8"
data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-26T18:00:13.307415Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-26T18:00:13.307125Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-26T19:33:48.701528Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-26T19:33:48.700212Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-26T18:00:13.307390Z&quot;}"
data-papermill="{&quot;duration&quot;:1713.259129,&quot;end_time&quot;:&quot;2023-05-13T14:31:22.908257&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-05-13T14:02:49.649128&quot;,&quot;status&quot;:&quot;completed&quot;}"
data-tags="[]" data-trusted="true">
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>train(model, dataloader_train_dataset, <span class="dv">100</span>, criterion, optimizer, device)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Epoch 1: acc = 0.06276784092187881, time = 79.4641432762146
Epoch 2: acc = 0.09388865530490875, time = 54.188974380493164
Epoch 3: acc = 0.10190162062644958, time = 54.23198199272156
Epoch 4: acc = 0.10880367457866669, time = 53.59248113632202
Epoch 5: acc = 0.12244798988103867, time = 55.75993633270264
Epoch 6: acc = 0.14781105518341064, time = 56.07185888290405
Epoch 7: acc = 0.17652352154254913, time = 57.210198640823364
Epoch 8: acc = 0.22088158130645752, time = 56.6973614692688
Epoch 9: acc = 0.24518553912639618, time = 55.366485595703125
Epoch 10: acc = 0.2672537565231323, time = 56.12690234184265
Epoch 11: acc = 0.28258585929870605, time = 55.96978712081909
Epoch 12: acc = 0.29463815689086914, time = 55.66333341598511
Epoch 13: acc = 0.3100627064704895, time = 55.1285617351532
Epoch 14: acc = 0.32350656390190125, time = 55.68712854385376
Epoch 15: acc = 0.33414167165756226, time = 55.27556753158569
Epoch 16: acc = 0.35104742646217346, time = 54.60121703147888
Epoch 17: acc = 0.37372705340385437, time = 54.697837352752686
Epoch 18: acc = 0.38643085956573486, time = 55.101847887039185
Epoch 19: acc = 0.4010574221611023, time = 54.78205227851868
Epoch 20: acc = 0.4159518778324127, time = 55.111764907836914
Epoch 21: acc = 0.4271271526813507, time = 55.1529061794281
Epoch 22: acc = 0.437041699886322, time = 55.27374482154846
Epoch 23: acc = 0.4531116187572479, time = 56.65343356132507
Epoch 24: acc = 0.46357694268226624, time = 55.81490087509155
Epoch 25: acc = 0.4738423228263855, time = 56.018189907073975
Epoch 26: acc = 0.4868852496147156, time = 56.04480791091919
Epoch 27: acc = 0.49822646379470825, time = 56.08814716339111
Epoch 28: acc = 0.5153800249099731, time = 55.8082435131073
Epoch 29: acc = 0.5286072492599487, time = 54.90609955787659
Epoch 30: acc = 0.5445312261581421, time = 54.93608021736145
Epoch 31: acc = 0.5568408370018005, time = 56.85424041748047
Epoch 32: acc = 0.5715653896331787, time = 54.39002275466919
Epoch 33: acc = 0.586504340171814, time = 54.02614116668701
Epoch 34: acc = 0.5989943742752075, time = 54.90618705749512
Epoch 35: acc = 0.620505690574646, time = 54.04360222816467
Epoch 36: acc = 0.6326215267181396, time = 55.85787296295166
Epoch 37: acc = 0.6505657434463501, time = 55.35590434074402
Epoch 38: acc = 0.6670811772346497, time = 54.72632837295532
Epoch 39: acc = 0.6835892796516418, time = 54.914082765579224
Epoch 40: acc = 0.7016699910163879, time = 55.093425273895264
Epoch 41: acc = 0.7154234647750854, time = 55.423096656799316
Epoch 42: acc = 0.730684757232666, time = 55.856257915496826
Epoch 43: acc = 0.745878279209137, time = 54.33305907249451
Epoch 44: acc = 0.7592914700508118, time = 55.44899106025696
Epoch 45: acc = 0.7724201083183289, time = 56.054773569107056
Epoch 46: acc = 0.7828208804130554, time = 55.26411557197571
Epoch 47: acc = 0.7936464548110962, time = 55.88620066642761
Epoch 48: acc = 0.806753933429718, time = 55.499868869781494
Epoch 49: acc = 0.8160955309867859, time = 55.61201596260071
Epoch 50: acc = 0.8239074945449829, time = 55.78139138221741
Epoch 51: acc = 0.8386353850364685, time = 55.43505239486694
Epoch 52: acc = 0.8482174873352051, time = 54.90142869949341
Epoch 53: acc = 0.8521071076393127, time = 55.20339751243591
Epoch 54: acc = 0.8632789850234985, time = 54.868210792541504
Epoch 55: acc = 0.8653950691223145, time = 56.972707748413086
Epoch 56: acc = 0.8759828209877014, time = 54.78121995925903
Epoch 57: acc = 0.8813903331756592, time = 54.55716633796692
Epoch 58: acc = 0.8857209086418152, time = 56.284013509750366
Epoch 59: acc = 0.8916245102882385, time = 55.63673686981201
Epoch 60: acc = 0.9003574252128601, time = 56.16262078285217
Epoch 61: acc = 0.901301920413971, time = 56.12161469459534
Epoch 62: acc = 0.9074427485466003, time = 56.63386797904968
Epoch 63: acc = 0.9116647243499756, time = 55.90363430976868
Epoch 64: acc = 0.9165326356887817, time = 55.92715644836426
Epoch 65: acc = 0.9179419875144958, time = 56.765052318573
Epoch 66: acc = 0.925944983959198, time = 56.643489599227905
Epoch 67: acc = 0.9240322113037109, time = 56.65227270126343
Epoch 68: acc = 0.9311213493347168, time = 55.71937608718872
Epoch 69: acc = 0.9306358098983765, time = 56.74690628051758
Epoch 70: acc = 0.9322322607040405, time = 55.99271774291992
Epoch 71: acc = 0.9350582361221313, time = 56.52279996871948
Epoch 72: acc = 0.9376903772354126, time = 56.874749183654785
Epoch 73: acc = 0.94090735912323, time = 57.45388841629028
Epoch 74: acc = 0.9420995116233826, time = 55.66647791862488
Epoch 75: acc = 0.9456254243850708, time = 56.03900718688965
Epoch 76: acc = 0.946043074131012, time = 56.58297514915466
Epoch 77: acc = 0.948685884475708, time = 56.33868932723999
Epoch 78: acc = 0.9529144763946533, time = 56.12341856956482
Epoch 79: acc = 0.9531829357147217, time = 55.38163208961487
Epoch 80: acc = 0.9549325108528137, time = 56.69886040687561
Epoch 81: acc = 0.9546468257904053, time = 57.151309967041016
Epoch 82: acc = 0.9558936357498169, time = 56.55665040016174
Epoch 83: acc = 0.955605149269104, time = 56.315571784973145
Epoch 84: acc = 0.9592430591583252, time = 55.83983564376831
Epoch 85: acc = 0.9606863260269165, time = 56.496082067489624
Epoch 86: acc = 0.9598305225372314, time = 55.96168923377991
Epoch 87: acc = 0.9626970887184143, time = 56.687360525131226
Epoch 88: acc = 0.9623441100120544, time = 56.22446036338806
Epoch 89: acc = 0.9623607993125916, time = 56.22408437728882
Epoch 90: acc = 0.966355562210083, time = 57.21049427986145
Epoch 91: acc = 0.9659106731414795, time = 57.723824977874756
Epoch 92: acc = 0.9652959704399109, time = 57.242239236831665
Epoch 93: acc = 0.9669229984283447, time = 56.452861309051514
Epoch 94: acc = 0.9678740501403809, time = 57.082189083099365
Epoch 95: acc = 0.964147686958313, time = 57.578141927719116
Epoch 96: acc = 0.9688485860824585, time = 56.357131481170654
Epoch 97: acc = 0.9708765149116516, time = 56.29270625114441
Epoch 98: acc = 0.9697962999343872, time = 55.940431118011475
Epoch 99: acc = 0.9703024625778198, time = 56.56537747383118
Epoch 100: acc = 0.9730405211448669, time = 55.69003891944885
Total time 5615.380129814148
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="15"
data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-26T19:34:54.346168Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-26T19:34:54.345792Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-26T19:35:17.840218Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-26T19:35:17.839141Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-26T19:34:54.346137Z&quot;}"
data-trusted="true">
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Acc = </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(get_f1_score(model, dataloader_val_dataset, device)))</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Acc = 0.9084368502009454
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="20"
data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-26T19:36:34.911854Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-26T19:36:34.911190Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-26T19:36:34.920468Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-26T19:36:34.919379Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-26T19:36:34.911809Z&quot;}"
data-papermill="{&quot;duration&quot;:2.1691e-2,&quot;end_time&quot;:&quot;2023-05-13T14:31:23.534095&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-05-13T14:31:23.512404&quot;,&quot;status&quot;:&quot;completed&quot;}"
data-tags="[]" data-trusted="true">
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> imshow(inp, title<span class="op">=</span><span class="va">None</span>, plt_ax<span class="op">=</span>plt, default<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    inp <span class="op">=</span> inp.numpy().transpose((<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    inp <span class="op">=</span> np.clip(inp, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    plt_ax.imshow(inp)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    plt_ax.grid(<span class="va">False</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_one_sample(model, img_tensor, device<span class="op">=</span>device):</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        img_tensor <span class="op">=</span> img_tensor.to(device)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        model.<span class="bu">eval</span>()</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        y_hat <span class="op">=</span> model(img_tensor).cpu()</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> torch.nn.functional.softmax(y_hat, dim<span class="op">=</span><span class="dv">1</span>).numpy()</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y_pred</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict(model, test_loader):</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        logits <span class="op">=</span> []</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> inputs <span class="kw">in</span> test_loader:</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>            inputs <span class="op">=</span> inputs.to(device)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>            model.<span class="bu">eval</span>()</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> model(inputs).cpu()</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>            logits.append(outputs)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    probs <span class="op">=</span> nn.functional.softmax(torch.cat(logits), dim<span class="op">=</span><span class="dv">1</span>).numpy()</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> probs</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="24"
data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-26T19:37:38.406544Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-26T19:37:38.405912Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-26T19:37:43.429883Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-26T19:37:43.428933Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-26T19:37:38.406510Z&quot;}"
data-papermill="{&quot;duration&quot;:1.568209,&quot;end_time&quot;:&quot;2023-05-13T14:31:25.209641&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-05-13T14:31:23.641432&quot;,&quot;status&quot;:&quot;completed&quot;}"
data-tags="[]" data-trusted="true">
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">5</span>, ncols<span class="op">=</span><span class="dv">5</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>),  sharey<span class="op">=</span><span class="va">True</span>, sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> fig_x <span class="kw">in</span> ax.flatten():</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    random_characters <span class="op">=</span> <span class="bu">int</span>(np.random.uniform(<span class="dv">0</span>, <span class="dv">1000</span>))</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    im_val, label <span class="op">=</span> val_dataset[random_characters]</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    img_label <span class="op">=</span> <span class="st">&quot; &quot;</span>.join(<span class="bu">map</span>(<span class="kw">lambda</span> x: x.capitalize(), val_dataset.label_encoder.inverse_transform([label])[<span class="dv">0</span>].split(<span class="st">&#39;_&#39;</span>)))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    imshow(im_val.data.cpu(), title<span class="op">=</span>img_label, plt_ax<span class="op">=</span>fig_x)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    fig_x.add_patch(patches.Rectangle((<span class="dv">0</span>, <span class="dv">0</span>), <span class="dv">185</span>, <span class="dv">40</span>,edgecolor <span class="op">=</span> <span class="st">&#39;black&#39;</span>,linewidth<span class="op">=</span><span class="dv">1</span>, facecolor<span class="op">=</span><span class="st">&#39;white&#39;</span>))</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    prob_pred <span class="op">=</span> predict_one_sample(model, im_val.unsqueeze(<span class="dv">0</span>))</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    predicted_proba <span class="op">=</span> np.<span class="bu">max</span>(prob_pred)<span class="op">*</span><span class="dv">100</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> np.argmax(prob_pred)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    predicted_label <span class="op">=</span> label_encoder.classes_[y_pred]</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    predicted_label <span class="op">=</span> predicted_label[:<span class="bu">len</span>(predicted_label)<span class="op">//</span><span class="dv">2</span>] <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span> <span class="op">+</span> predicted_label[<span class="bu">len</span>(predicted_label)<span class="op">//</span><span class="dv">2</span>:]</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    predicted_text <span class="op">=</span> <span class="st">&quot;</span><span class="sc">{}</span><span class="st"> : </span><span class="sc">{:.0f}</span><span class="st">%&quot;</span>.<span class="bu">format</span>(predicted_label,predicted_proba)       </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    fig_x.text(<span class="dv">1</span>, <span class="dv">35</span>, predicted_text)</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_99031cff706e41c6af7ac5ed5c4dbc9f/ff1b40e2840b0e86485f8cb59434b3097b100114.png" /></p>
</div>
</div>
</body>
</html>
